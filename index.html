<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ø£Ø«Ø± - Impact Compass</title>

<!-- SheetJS Ù„Ù‚Ø±Ø§Ø¡Ø© Excel | jsPDF + html2canvas Ù„Ù„Ø´Ù‡Ø§Ø¯Ø© -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  :root{
    --primary:#5a2d91;       /* Ø§Ù„Ø¨Ù†ÙØ³Ø¬ÙŠ */
    --primary-600:#4a1f7b;
    --bg:#f6f5fa;
    --text:#101318;
  }

  /* Ø¶Ø¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ø®Ø· Ø¯Ø§Ø®Ù„ Ù…Ø¬Ù„Ø¯ fonts/ Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„ØµÙØ­Ø© */
  @font-face{
    font-family:'DINNextArabic';
    src:
      url('fonts/DINNextLTArabic-Regular.ttf') format('truetype'),
      url('fonts/DIN NEXTâ„¢ï¸ ARABIC BOLD 2.otf') format('opentype'),
      url('fonts/DIN NEXTâ„¢ï¸ ARABIC HEAVY 3.otf') format('opentype'),
      url('fonts/DIN NEXTâ„¢ï¸ ARABIC ULTRALIGHT 2.otf') format('opentype');
    font-weight:normal; font-style:normal; font-display:swap;
  }

  *{box-sizing:border-box}
  body{
    margin:0; background:var(--bg); color:var(--text);
    font-family:'DINNextArabic', Arial, sans-serif; line-height:1.7;
  }

  .topbar{
    background:var(--primary); color:#fff; padding:10px 14px;
    display:flex; align-items:center; justify-content:space-between;
  }
  .logos{display:flex; align-items:center; gap:14px}
  .logos img{height:40px; object-fit:contain}

  .lang-toggle{
    background:#fff; color:var(--primary); border:0; border-radius:10px;
    padding:8px 12px; cursor:pointer; font-weight:700;
  }

  .container{
    max-width:760px; margin:24px auto; background:#fff; border-radius:14px;
    box-shadow:0 8px 30px rgba(0,0,0,.06); padding:22px;
  }

  h1{margin:8px 0 2px; color:var(--primary); text-align:center}
  .subtitle{text-align:center; color:#555; margin-bottom:14px}

  .grid-2{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  input[type="text"],input[type="email"],input[type="tel"]{
    width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; font-size:15px;
  }

  .progress{margin:16px 0; height:10px; background:#eee; border-radius:999px; overflow:hidden}
  .progress>span{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--primary),var(--primary-600)); transition:width 300ms}

  .card{background:#faf9ff; border:1px solid #eee; border-radius:12px; padding:16px; margin-top:10px}
  .q-title{margin:0 0 10px; font-weight:800; color:#272a31}
  label.option{display:block; padding:10px 12px; border-radius:10px; border:1px solid #e8e8ef; margin:8px 0; cursor:pointer}
  label.option:hover{border-color:var(--primary)}

  .actions{display:flex; gap:10px; justify-content:space-between; margin-top:12px}
  .btn{background:var(--primary); color:#fff; border:0; padding:10px 16px; border-radius:10px; cursor:pointer; font-weight:800}
  .btn:disabled{opacity:.4; cursor:not-allowed}
  .btn.secondary{background:#7e7e86}
  .btn.ghost{background:#fff; color:var(--primary); border:2px solid var(--primary)}

  .result{display:none; margin-top:14px; padding:14px; border-radius:12px; background:#f0ecfb; border:1px solid #e0d8f7; text-align:center}

  .footer-note{text-align:center; color:#8c8c93; margin-top:10px; font-size:13px}

  /* Ø´Ù‡Ø§Ø¯Ø© */
  .cert-wrap{width:100%; display:none; justify-content:center; margin-top:16px}
  .certificate{
    width:100%; max-width:800px; aspect-ratio:1.414; /* A4 ØªÙ‚Ø±ÙŠØ¨Ù‹Ø§ */
    border:6px solid var(--primary); border-radius:18px; background:#fff;
    display:flex; flex-direction:column; justify-content:center; align-items:center; gap:18px; padding:20px;
  }
  .cert-logos{display:flex; gap:18px; align-items:center}
  .cert-logos img{height:64px}
  .cert-name{font-size:42px; font-weight:900; color:var(--primary); text-align:center; word-break:break-word}

  .rtl{direction:rtl}
  .ltr{direction:ltr}
</style>
</head>
<body>

<!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
<header class="topbar">
  <div class="logos">
    <!-- Ø¶Ø¹ one-logo.png Ùˆ misklogo.png Ø¨Ø¬ÙˆØ§Ø± Ø§Ù„ØµÙØ­Ø© -->
    <img src="one-logo.png" alt="One Logo" />
    <img src="misklogo.png" alt="Misk Logo" />
  </div>
  <button id="langBtn" class="lang-toggle">English</button>
</header>

<main class="container">
  <h1 id="title">ğŸ§­ Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ø£Ø«Ø±</h1>
  <div id="subtitle" class="subtitle">Ø³Ø¬Ù‘Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒØŒ Ø«Ù… Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹.</div>

  <!-- ØµÙØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
  <section id="userForm">
    <div class="grid-2">
      <div>
        <label id="lblName" for="name">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
        <input type="text" id="name" placeholder="Ø§ÙƒØªØ¨ Ø§Ø³Ù…Ùƒ Ù‡Ù†Ø§" />
      </div>
      <div>
        <label id="lblEmail" for="email">Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„</label>
        <input type="email" id="email" placeholder="example@email.com" />
      </div>
    </div>
    <div style="margin-top:10px">
      <label id="lblPhone" for="phone">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
      <input type="tel" id="phone" placeholder="05xxxxxxxx" />
    </div>
    <div class="actions" style="justify-content:flex-end; margin-top:8px">
      <button class="btn" id="startBtn">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
    </div>
  </section>

  <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… -->
  <div id="progressWrap" style="display:none">
    <div class="progress"><span id="progressBar"></span></div>
    <div id="stepText" style="text-align:center; color:#666; font-size:14px"></div>
  </div>

  <!-- Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø³Ø¤Ø§Ù„ -->
  <section id="questionArea" style="display:none">
    <div class="card">
      <p class="q-title" id="qTitle">Ø³Ø¤Ø§Ù„ 1</p>
      <div id="options"></div>
      <div class="actions">
        <button class="btn ghost" id="prevBtn">âŸµ Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        <div style="display:flex; gap:8px">
          <button class="btn secondary" id="saveBtn">Ø­ÙØ¸ & Ø§Ù„ØªØ§Ù„ÙŠ</button>
          <button class="btn" id="nextBtn">Ø§Ù„ØªØ§Ù„ÙŠ âŸ¶</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
  <section id="resultBox" class="result"></section>

  <!-- Ø£Ø²Ø±Ø§Ø± Ù…Ø§ Ø¨Ø¹Ø¯ Ø§Ù„Ù†ØªÙŠØ¬Ø© -->
  <div id="postActions" class="actions" style="display:none; justify-content:center">
    <button class="btn" id="downloadCSV">ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬ CSV</button>
    <button class="btn secondary" id="restartBtn">Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±</button>
    <button class="btn ghost" id="certBtn">Ø·Ø¨Ø§Ø¹Ø© Ø´Ù‡Ø§Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù…</button>
  </div>

  <!-- Ø´Ù‡Ø§Ø¯Ø© HTML (Ù„Ù„ØªØµØ¯ÙŠØ± PDF) -->
  <div id="certWrap" class="cert-wrap">
    <div id="certificate" class="certificate">
      <div class="cert-logos">
        <!-- Ù…Ù‡Ù…: crossOrigin ÙŠØ­Ø³Ù‘Ù† Ø§Ù„ØªÙ‚Ø§Ø· Ø§Ù„ØµÙˆØ± Ù…Ø¹ html2canvas -->
        <img src="one-logo.png" alt="One Logo" crossOrigin="anonymous" />
        <img src="misklogo.png" alt="Misk Logo" crossOrigin="anonymous" />
      </div>
      <div id="certName" class="cert-name">Ø§Ø³Ù… Ø§Ù„Ù…ÙØ´Ø§Ø±Ùƒ</div>
    </div>
  </div>

  <div class="footer-note">Â© ÙˆÙ† | Misk â€” ØªØ¬Ø±Ø¨Ø© Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ø£Ø«Ø±</div>
</main>

<script>
/* =================== Ø§Ù„Ù„ØºØ© =================== */
const STRINGS = {
  ar:{
    title:"ğŸ§­ Ø¨ÙˆØµÙ„Ø© Ø§Ù„Ø£Ø«Ø±",
    subtitle:"Ø³Ø¬Ù‘Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒØŒ Ø«Ù… Ø£Ø¬Ø¨ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ø¨Ø§Ù„ØªØªØ§Ø¨Ø¹.",
    lblName:"Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„",
    lblEmail:"Ø§Ù„Ø¥ÙŠÙ…ÙŠÙ„",
    lblPhone:"Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„",
    start:"Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±",
    prev:"âŸµ Ø§Ù„Ø³Ø§Ø¨Ù‚",
    saveNext:"Ø­ÙØ¸ & Ø§Ù„ØªØ§Ù„ÙŠ",
    next:"Ø§Ù„ØªØ§Ù„ÙŠ âŸ¶",
    step:(i,n)=>`Ø§Ù„Ø³Ø¤Ø§Ù„ ${i} Ù…Ù† ${n}`,
    mustUser:"Ù…Ù† ÙØ¶Ù„Ùƒ Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… ÙˆØ§Ù„Ø¥ÙŠÙ…ÙŠÙ„ ÙˆØ±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ Ø£ÙˆÙ„Ù‹Ø§.",
    mustAnswer:"Ø§Ø®ØªØ± Ø¥Ø¬Ø§Ø¨Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„Ø³Ø¤Ø§Ù„ Ø§Ù„ØªØ§Ù„ÙŠ.",
    result:(persona,percent)=>`Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø£Ù‚Ø±Ø¨ Ù„Ùƒ: <b>${persona}</b> â€” Ù†Ø³Ø¨Ø© Ø§Ù„ØªÙˆØ§ÙÙ‚: <b>${percent}%</b>`,
    downloadCSV:"ØªØ­Ù…ÙŠÙ„ Ù…Ù„Ù Ø§Ù„Ù†ØªØ§Ø¦Ø¬ CSV",
    restart:"Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±",
    cert:"Ø·Ø¨Ø§Ø¹Ø© Ø´Ù‡Ø§Ø¯Ø© Ø¨Ø§Ù„Ø§Ø³Ù…",
    langBtn:"English",
    personas:{Analysis:"Analysis Person", Creative:"Creative Person", PR:"PR Person", Reliable:"Reliable Person"}
  },
  en:{
    title:"ğŸ§­ Impact Compass",
    subtitle:"Fill your details, then answer questions one by one.",
    lblName:"Full Name",
    lblEmail:"Email",
    lblPhone:"Phone",
    start:"Start Quiz",
    prev:"âŸµ Previous",
    saveNext:"Save & Next",
    next:"Next âŸ¶",
    step:(i,n)=>`Question ${i} of ${n}`,
    mustUser:"Please enter name, email, and phone first.",
    mustAnswer:"Please select an answer before moving on.",
    result:(persona,percent)=>`Your best-fit track: <b>${persona}</b> â€” Match: <b>${percent}%</b>`,
    downloadCSV:"Download CSV",
    restart:"Restart",
    cert:"Print name certificate",
    langBtn:"Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©",
    personas:{Analysis:"Analysis Person", Creative:"Creative Person", PR:"PR Person", Reliable:"Reliable Person"}
  }
};
let LANG = localStorage.getItem('impact_lang') || 'ar';
function applyLang(){
  const S = STRINGS[LANG];
  document.documentElement.lang = LANG;
  document.documentElement.classList.toggle('rtl', LANG==='ar');
  document.documentElement.classList.toggle('ltr', LANG==='en');
  document.getElementById('title').innerText = S.title;
  document.getElementById('subtitle').innerText = S.subtitle;
  document.getElementById('lblName').innerText = S.lblName;
  document.getElementById('lblEmail').innerText = S.lblEmail;
  document.getElementById('lblPhone').innerText = S.lblPhone;
  document.getElementById('startBtn').innerText = S.start;
  document.getElementById('prevBtn').innerText = S.prev;
  document.getElementById('saveBtn').innerText = S.saveNext;
  document.getElementById('nextBtn').innerText = S.next;
  document.getElementById('downloadCSV').innerText = S.downloadCSV;
  document.getElementById('restartBtn').innerText = S.restart;
  document.getElementById('certBtn').innerText = S.cert;
  document.getElementById('langBtn').innerText = S.langBtn;
}
document.getElementById('langBtn').addEventListener('click', ()=>{
  LANG = (LANG==='ar')? 'en':'ar';
  localStorage.setItem('impact_lang', LANG);
  applyLang();
  renderQuestion();
});

/* ======= ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø³Ø¦Ù„Ø© Ù…Ù† Excel Ø¥Ù† ÙˆÙØ¬Ø¯ ======= */
/* ØªÙˆÙ‚Ù‘Ø¹Ø§Øª Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©:
   Question_AR, A_AR, B_AR, C_AR, D_AR,
   Question_EN, A_EN, B_EN, C_EN, D_EN,
   Persona_A, Persona_B, Persona_C, Persona_D,
   Weight_A, Weight_B, Weight_C, Weight_D
*/
let QUESTIONS = [];
let ANSWERS = {};
let personaScores = {Analysis:0, Creative:0, PR:0, Reliable:0};
let currentIndex = 0;
let submissions = [];

async function tryLoadExcel(){
  try{
    const res = await fetch('impact-mapping.xlsx', {cache:'no-store'});
    if(!res.ok) throw new Error('no xlsx');
    const buf = await res.arrayBuffer();
    const wb = XLSX.read(buf,{type:'array'});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    const rows = XLSX.utils.sheet_to_json(sheet,{defval:''});

    QUESTIONS = rows.map((r,idx)=>({
      id: idx+1,
      ar: { q:r.Question_AR || `Ø³Ø¤Ø§Ù„ ${idx+1}`, options:{A:r.A_AR,B:r.B_AR,C:r.C_AR,D:r.D_AR} },
      en: { q:r.Question_EN || `Question ${idx+1}`, options:{A:r.A_EN,B:r.B_EN,C:r.C_EN,D:r.D_EN} },
      mapping: {
        A:{persona:normPersona(r.Persona_A), weight:num(r.Weight_A,1)},
        B:{persona:normPersona(r.Persona_B), weight:num(r.Weight_B,1)},
        C:{persona:normPersona(r.Persona_C), weight:num(r.Weight_C,1)},
        D:{persona:normPersona(r.Persona_D), weight:num(r.Weight_D,1)},
      }
    })).filter(q => q.ar.options.A || q.en.options.A);
  }catch(e){
    QUESTIONS = fallbackQuestions();
  }
}
function normPersona(p){
  if(!p) return 'Reliable';
  const s = (''+p).toLowerCase();
  if(s.includes('anal')) return 'Analysis';
  if(s.includes('creat')) return 'Creative';
  if(s.includes('pr')) return 'PR';
  if(s.includes('reli')) return 'Reliable';
  return 'Reliable';
}
function num(v,d=1){ const n=parseFloat(v); return Number.isFinite(n)? n:d; }

function fallbackQuestions(){
  const base=[ // Ù†ÙØ³ Ø£Ø³Ø¦Ù„Ø© fallback Ø§Ù„Ø³Ø¨Ø¹Ø©
    {arQ:'Ù„Ù…Ø§ ØªÙˆØ§Ø¬Ù‡ ØªØ­Ø¯Ù‘ÙŠØŒ ÙˆØ´ Ø£ÙˆÙ„ Ø´ÙŠØ¡ ØªØ³ÙˆÙŠÙ‡ØŸ', arA:'ØªØ®Ø·Ø· ÙˆØªØ¬Ù…Ø¹ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª', arB:'ØªØ¨ØªÙƒØ± ÙÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©', arC:'ØªØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¢Ø®Ø±ÙŠÙ† Ù„Ø­Ù„Ù‘Ù‡', arD:'ØªÙˆØ«Ù‚ ÙƒÙ„ Ø´ÙŠØ¡ Ø¨Ø®Ø·ÙˆØ§Øª ÙˆØ§Ø¶Ø­Ø©',
     enQ:'When you face a challenge, what do you do first?', enA:'Plan & gather info', enB:'Come up with a new idea', enC:'Talk to others to solve it', enD:'Document clear steps',
     map:{A:'Analysis',B:'Creative',C:'PR',D:'Reliable'}},
    {arQ:'Ø£ÙƒØ«Ø± Ø´ÙŠ ØªØ­Ø¨Ù‘Ù‡ ÙÙŠ Ø§Ù„Ø´ØºÙ„ Ø§Ù„Ø¬Ù…Ø§Ø¹ÙŠØŸ', arA:'Ø§Ù„ØªÙ†Ø¸ÙŠÙ… ÙˆØ§Ù„ØªÙˆØ²ÙŠØ¹', arB:'Ø§Ù„Ø¹ØµÙ Ø§Ù„Ø°Ù‡Ù†ÙŠ ÙˆØ§Ù„Ø¥Ø¨Ø¯Ø§Ø¹', arC:'Ø§Ù„Ø­Ù…Ø§Ø³ ÙˆØ§Ù„Ø·Ø§Ù‚Ø© Ø¨ÙŠÙ† Ø§Ù„ÙØ±ÙŠÙ‚', arD:'Ø§Ù„ØªÙˆØ«ÙŠÙ‚ ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©',
     enQ:'What do you like most in teamwork?', enA:'Organizing & assigning', enB:'Brainstorming & creativity', enC:'Team energy', enD:'Documentation & outcomes',
     map:{A:'Analysis',B:'Creative',C:'PR',D:'Reliable'}},
    {arQ:'ØªÙØ¶Ù‘Ù„ ØªÙƒÙˆÙ† Ø®Ù„Ù Ø§Ù„ÙƒÙˆØ§Ù„ÙŠØ³ ÙˆÙ„Ø§ ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©ØŸ', arA:'Ø®Ù„Ù Ø§Ù„ÙƒÙˆØ§Ù„ÙŠØ³ â€“ Ø£Ø­Ø¨ Ø£Ø¶Ø¨Ø· Ø§Ù„ØªÙØ§ØµÙŠÙ„', arB:'ÙÙŠ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© â€“ Ø£Ø­Ø¨ Ø£ØªÙƒÙ„Ù… ÙˆØ£Ù‚Ù†Ø¹', arC:'Ø¨ÙŠÙ† Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', arD:'Ø§Ù„Ù…Ù‡Ù… ÙŠÙ†Ø¬Ø­ Ø§Ù„Ø¹Ù…Ù„',
     enQ:'Backstage or frontstage?', enA:'Backstageâ€”polish details', enB:'Frontstageâ€”speak & persuade', enC:'Balance both', enD:'Whatever gets it done',
     map:{A:'Analysis',B:'PR',C:'Creative',D:'Reliable'}},
    {arQ:'Ø£ÙƒØ«Ø± Ø´ÙŠ ÙŠØ¬Ø°Ø¨Ùƒ ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙŠØ¹ Ø§Ù„Ø¥Ø¹Ù„Ø§Ù…ÙŠØ©ØŸ', arA:'Ø§Ù„ØªØ®Ø·ÙŠØ· ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„Ø©', arB:'Ø§Ù„Ø¥Ø¨Ø¯Ø§Ø¹ ÙˆØ§Ù„Ù‡ÙˆÙŠØ©', arC:'Ø§Ù„Ø¹Ù„Ø§Ù‚Ø§Øª ÙˆØ§Ù„ØªÙØ§Ø¹Ù„ Ù…Ø¹ Ø§Ù„Ø¬Ù…Ù‡ÙˆØ±', arD:'Ø§Ù„ØªÙˆØ«ÙŠÙ‚ ÙˆØ§Ù„Ø¥Ø®Ø±Ø§Ø¬',
     enQ:'What attracts you in media projects?', enA:'Planning & scheduling', enB:'Creative identity', enC:'Public engagement', enD:'Documentation & delivery',
     map:{A:'Analysis',B:'Creative',C:'PR',D:'Reliable'}},
    {arQ:'Ù„Ù…Ø§ ØªØ´ÙˆÙ ÙÙƒØ±Ø© Ø¬Ø¯ÙŠØ¯Ø©ØŒ ÙˆØ´ Ø£ÙˆÙ„ Ø´ÙŠ ÙŠØ®Ø·Ø± Ø¨Ø¨Ø§Ù„ÙƒØŸ', arA:'ÙƒÙŠÙ Ù†Ø·Ø¨Ù‘Ù‚Ù‡Ø§ Ø¹Ù…Ù„ÙŠÙ‹Ø§ØŸ', arB:'ÙƒÙŠÙ Ù†Ø®Ù„ÙŠÙ‡Ø§ Ø£Ø¨Ø¯Ø¹ØŸ', arC:'ÙƒÙŠÙ Ù†ÙˆØµÙ„Ù‡Ø§ Ù„Ù„Ù†Ø§Ø³ØŸ', arD:'ÙƒÙŠÙ Ù†ÙˆØ«Ù‘Ù‚Ù‡Ø§ Ø£Ùˆ Ù†Ù‚ÙŠØ³ Ø£Ø«Ø±Ù‡Ø§ØŸ',
     enQ:'See a new ideaâ€”whatâ€™s first?', enA:'How to execute it?', enB:'How to make it more creative?', enC:'How to reach people?', enD:'How to document/measure?',
     map:{A:'Reliable',B:'Creative',C:'PR',D:'Analysis'}},
    {arQ:'Ù„Ùˆ Ø§Ù†Ø¶Ù…Ù‘ÙŠØª Ù„ÙØ±ÙŠÙ‚ "ÙˆÙÙ†"ØŒ Ø£ÙŠ Ø¯ÙˆØ± ÙŠÙ†Ø§Ø³Ø¨ÙƒØŸ', arA:'Ù…Ù†Ø³Ù‘Ù‚ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹', arB:'Ø§Ù„Ù…Ø¨Ø¯Ø¹', arC:'Ø§Ù„Ù…ØªØ­Ø¯Ø«', arD:'Ø§Ù„Ù…Ù†ØªØ¬',
     enQ:'If you join Team One, best role?', enA:'Project coordinator', enB:'Creative maker', enC:'Spokesperson', enD:'Producer',
     map:{A:'Analysis',B:'Creative',C:'PR',D:'Reliable'}},
    {arQ:'ÙˆØ´ Ø£ÙƒØ«Ø± Ø´Ø¹ÙˆØ± ØªØ­Ø¨ ØªØ­Ù‚Ù‚Ù‡ Ø¨Ø¹Ø¯ Ø¥Ù†Ø¬Ø§Ø² Ù…Ø´Ø±ÙˆØ¹ØŸ', arA:'Ù†ÙØ°Ù†Ø§ Ø§Ù„Ø®Ø·Ø© Ø¨Ø¯Ù‚Ø©', arB:'Ù‚Ø¯Ù‘Ù…Ù†Ø§ ÙÙƒØ±Ø© ØºÙŠØ± Ù…Ø³Ø¨ÙˆÙ‚Ø©', arC:'Ø£Ø«Ø±Ù†Ø§ ÙÙŠ Ø§Ù„Ù†Ø§Ø³', arD:'ÙˆØ«Ù‚Ù†Ø§ ØªØ¬Ø±Ø¨Ø© ØªØ³ØªØ­Ù‚ Ø§Ù„ØªÙƒØ±Ø§Ø±',
     enQ:'Best feeling after a project?', enA:'Plan executed perfectly', enB:'Novel idea delivered', enC:'People were impacted', enD:'Documented for repeatability',
     map:{A:'Analysis',B:'Creative',C:'PR',D:'Reliable'}}
  ];
  return base.map((b,i)=>({
    id:i+1,
    ar:{q:b.arQ, options:{A:b.arA,B:b.arB,C:b.arC,D:b.arD}},
    en:{q:b.enQ, options:{A:b.enA,B:b.enB,C:b.enC,D:b.enD}},
    mapping:{
      A:{persona:b.map.A, weight:1},
      B:{persona:b.map.B, weight:1},
      C:{persona:b.map.C, weight:1},
      D:{persona:b.map.D, weight:1}
    }
  }));
}

/* =================== Ù…Ù†Ø·Ù‚ UI =================== */
const qArea=document.getElementById('questionArea');
const qTitle=document.getElementById('qTitle');
const optionsWrap=document.getElementById('options');
const progressWrap=document.getElementById('progressWrap');
const progressBar=document.getElementById('progressBar');
const stepText=document.getElementById('stepText');

document.getElementById('startBtn').addEventListener('click', ()=>{
  const name=val('name'), email=val('email'), phone=val('phone');
  if(!name || !email || !phone){ alert(STRINGS[LANG].mustUser); return; }
  document.getElementById('userForm').style.display='none';
  qArea.style.display='block';
  progressWrap.style.display='block';
  renderQuestion();
});
document.getElementById('prevBtn').addEventListener('click', ()=>{
  if(currentIndex>0){ currentIndex--; renderQuestion(); }
});
document.getElementById('nextBtn').addEventListener('click', ()=>{
  if(!ensureAnswered()) return;
  if(currentIndex<QUESTIONS.length-1){ currentIndex++; renderQuestion(); }
  else { finish(); }
});
document.getElementById('saveBtn').addEventListener('click', ()=>{
  if(!ensureAnswered()) return;
  if(currentIndex<QUESTIONS.length-1){ currentIndex++; renderQuestion(); }
  else { finish(); }
});

function val(id){ return document.getElementById(id).value.trim(); }

function renderQuestion(){
  applyLang();
  if(!QUESTIONS.length) return;
  const q=QUESTIONS[currentIndex];
  const S=STRINGS[LANG];
  const text=(LANG==='ar')? q.ar.q : q.en.q;
  const ops =(LANG==='ar')? q.ar.options : q.en.options;

  qTitle.textContent = text || (LANG==='ar'? `Ø³Ø¤Ø§Ù„ ${q.id}` : `Question ${q.id}`);
  optionsWrap.innerHTML='';
  ['A','B','C','D'].forEach(k=>{
    if(!ops[k]) return;
    const id=`q_${q.id}_${k}`;
    const lab=document.createElement('label');
    lab.className='option';
    lab.htmlFor=id;
    lab.innerHTML=`<input type="radio" name="q${q.id}" id="${id}" value="${k}" ${ANSWERS[q.id]===k?'checked':''}/> ${ops[k]}`;
    optionsWrap.appendChild(lab);
  });

  const pct=Math.round((currentIndex/QUESTIONS.length)*100);
  progressBar.style.width=pct+'%';
  stepText.textContent=S.step(currentIndex+1, QUESTIONS.length);

  document.getElementById('prevBtn').disabled=(currentIndex===0);
  document.getElementById('nextBtn').textContent=(currentIndex===QUESTIONS.length-1)? (LANG==='ar'?'Ø¥Ù†Ù‡Ø§Ø¡':'Finish') : S.next;
  document.getElementById('saveBtn').textContent=(currentIndex===QUESTIONS.length-1)? (LANG==='ar'?'Ø­ÙØ¸ & Ø¥Ù†Ù‡Ø§Ø¡':'Save & Finish') : S.saveNext;
}

function ensureAnswered(){
  const q=QUESTIONS[currentIndex];
  const selected=document.querySelector(`input[name="q${q.id}"]:checked`);
  if(!selected){ alert(STRINGS[LANG].mustAnswer); return false; }
  ANSWERS[q.id]=selected.value;
  return true;
}

function computeScores(){
  personaScores={Analysis:0, Creative:0, PR:0, Reliable:0};
  let total=0;
  QUESTIONS.forEach(q=>{
    const a=ANSWERS[q.id]; if(!a) return;
    const m=q.mapping[a] || {persona:'Reliable', weight:1};
    personaScores[m.persona]+=m.weight; total+=m.weight;
  });
  return total||1;
}

function finish(){
  const total=computeScores();
  let winner='Reliable', max=-1;
  for(const k in personaScores){ if(personaScores[k]>max){ max=personaScores[k]; winner=k; } }
  const percent=Math.round((max/total)*100);

  const S=STRINGS[LANG];
  const res=document.getElementById('resultBox');
  res.innerHTML=S.result(S.personas[winner], percent);
  res.style.display='block';
  document.getElementById('postActions').style.display='flex';

  document.getElementById('certName').textContent=val('name');
  document.getElementById('certWrap').style.display='flex';

  const row={
    name:val('name'), email:val('email'), phone:val('phone'),
    persona:winner, percentage:percent,
    answers:QUESTIONS.map(q=>ANSWERS[q.id]||'')
  };
  submissions.push(row);
}

/* =================== CSV =================== */
document.getElementById('downloadCSV').addEventListener('click', ()=>{
  if(!submissions.length) return;
  const qCols=QUESTIONS.map((q,i)=>`Q${i+1}`);
  const headers=["Name","Email","Phone",...qCols,"Persona","Percentage"];
  const rows=submissions.map(s=>[s.name,s.email,s.phone,...s.answers,s.persona, s.percentage+"%"]);

  let csv=headers.join(",")+"\n";
  rows.forEach(r=>{ csv += r.map(v=>`"${(v??'').toString().replace(/"/g,'""')}"`).join(",")+"\n"; });

  const blob=new Blob([csv],{type:"text/csv;charset=utf-8;"});
  const a=document.createElement('a');
  a.href=URL.createObjectURL(blob);
  a.download="impact_compass_results.csv";
  document.body.appendChild(a); a.click(); a.remove();
});

/* ============== Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± (ØªØ±Ø¬Ø¹ Ù„Ø£ÙˆÙ„ ØµÙØ­Ø© ÙÙ‚Ø·) ============== */
document.getElementById('restartBtn').addEventListener('click', ()=>{
  ANSWERS={};
  personaScores={Analysis:0, Creative:0, PR:0, Reliable:0};
  currentIndex=0;

  // Ø§Ø®ÙÙ ÙƒÙ„ Ø£Ø¬Ø²Ø§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±/Ø§Ù„Ù†ØªÙŠØ¬Ø©/Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
  document.getElementById('resultBox').style.display='none';
  document.getElementById('postActions').style.display='none';
  document.getElementById('certWrap').style.display='none';
  document.getElementById('questionArea').style.display='none';
  document.getElementById('progressWrap').style.display='none';

  // Ø£Ø¸Ù‡Ø± ØµÙØ­Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙ‚Ø·
  document.getElementById('userForm').style.display='block';

  // Ù†Ø¸Ù‘Ù Ø§Ù„Ø­Ù‚ÙˆÙ„
  document.getElementById('name').value='';
  document.getElementById('email').value='';
  document.getElementById('phone').value='';

  // Ø±Ø¬ÙˆØ¹ Ù„Ø£Ø¹Ù„Ù‰ Ø§Ù„ØµÙØ­Ø©
  window.scrollTo({top:0, behavior:'smooth'});
});

/* ============== Ø·Ø¨Ø§Ø¹Ø©/ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø´Ù‡Ø§Ø¯Ø© PDF (Ù…Ø¹ fallback PNG) ============== */
document.getElementById('certBtn').addEventListener('click', async ()=>{
  const cert=document.getElementById('certificate');
  const fileName=(document.getElementById('name').value.trim() || 'certificate') + '.pdf';

  try{
    // Ø§Ù†ØªØ¸Ø± ØªØ­Ù…ÙŠÙ„ Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø´Ù‡Ø§Ø¯Ø©
    const imgs=cert.querySelectorAll('img');
    await Promise.all(Array.from(imgs).map(img=>{
      if(img.complete) return Promise.resolve();
      return new Promise(res=>{ img.onload=img.onerror=res; });
    }));

    const canvas=await html2canvas(cert,{
      scale:2, useCORS:true, allowTaint:true, backgroundColor:'#ffffff', logging:false
    });
    const imgData=canvas.toDataURL('image/png');

    const {jsPDF}=window.jspdf;
    const pdf=new jsPDF({orientation:'portrait', unit:'pt', format:'a4'});
    const pageW=pdf.internal.pageSize.getWidth();
    const pageH=pdf.internal.pageSize.getHeight();

    const ratio=Math.min(pageW*0.9/canvas.width, pageH*0.9/canvas.height);
    const w=canvas.width*ratio, h=canvas.height*ratio;
    const x=(pageW-w)/2, y=(pageH-h)/2;

    pdf.addImage(imgData,'PNG',x,y,w,h);
    pdf.save(fileName);
  }catch(err){
    console.error('PDF failed, falling back to PNG:', err);
    const pngCanvas=await html2canvas(cert,{scale:2,useCORS:true,allowTaint:true,backgroundColor:'#ffffff'});
    const a=document.createElement('a');
    a.href=pngCanvas.toDataURL('image/png');
    a.download=(document.getElementById('name').value.trim() || 'certificate') + '.png';
    document.body.appendChild(a); a.click(); a.remove();
  }
});

/* =================== Boot =================== */
(async function init(){
  applyLang();
  await tryLoadExcel();   // ÙŠØ­Ù…Ù„ impact-mapping.xlsx Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ ÙˆØ¥Ù„Ø§ ÙŠØ³ØªØ®Ø¯Ù… fallback
})();
</script>
</body>
</html>
